<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì»´í“¨í„°ì‹¤ ëŒ€ê²°: ìœ„ì¹˜ ì…”í”Œ & ì‹¤ì‹œê°„ ë™ê¸°í™” V23</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <style>
        body { background: #000; color: #00ff00; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; }
        
        /* ë¡œë¹„ í™”ë©´ */
        #lobby { position: fixed; inset: 0; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .monitor-btn { width: 180px; height: 100px; font-family: 'DungGeunMo'; font-size: 1.2rem; cursor: pointer; margin: 10px; background: #333; color: white; border: 4px outset #888; }
        .start-trigger { margin-top: 30px; padding: 15px 40px; font-size: 1.5rem; background: #f1c40f; color: #000; cursor: pointer; border: none; font-family: 'DungGeunMo'; }

        /* ê²Œì„ í™”ë©´ */
        #game-container { display: none; flex-direction: column; align-items: center; width: 100vw; height: 100vh; }
        #header { width: 100%; padding: 10px; background: #222; border-bottom: 4px inset #555; display: flex; flex-direction: column; align-items: center; }
        
        #score-board { display: flex; gap: 30px; font-size: 1.8rem; margin-bottom: 5px; }
        .score.red { color: #e74c3c; }
        .score.blue { color: #3498db; }

        .time-bar-bg { width: 80%; height: 15px; background: #111; border: 2px inset #555; }
        #time-bar { width: 100%; height: 100%; background: #00ff00; transition: width 0.1s linear; }

        /* ê²Œì„ ê·¸ë¦¬ë“œ (ìœ„ì¹˜ ì…”í”Œì˜ í•µì‹¬) */
        #game-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; width: 100vw; height: 75vh; gap: 10px; padding: 10px; box-sizing: border-box; }
        .monitor-container { display: flex; flex-direction: column; align-items: center; transition: all 0.5s ease-in-out; }
        
        .teacher-box { width: 70px; height: 50px; font-size: 2.5rem; display: flex; justify-content: center; align-items: center; background: #333; border: 4px solid #555; border-radius: 8px 8px 0 0; margin-bottom: -4px; }
        .teacher-box.watching { background: #ff0000; animation: shake 0.1s infinite; }

        .monitor-frame { width: 100%; height: 100%; border: 8px outset #aaa; background: #000; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; }
        .red-team { border-color: #e74c3c !important; }
        .blue-team { border-color: #3498db !important; }
        .my-border { border-style: double !important; border-width: 10px !important; box-shadow: 0 0 20px #0f0; } /* ë‚´ ëª¨ë‹ˆí„° ê°•ì¡° */

        .board { display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px; flex: 1; }
        .card { height: 20px; background: #222; color: #444; font-size: 0.5rem; display: flex; justify-content: center; align-items: center; border-radius: 2px; }
        .card.red { background: #e74c3c; color: white; }
        .card.blue { background: #3498db; color: white; }

        .input-area { margin-top: 10px; width: 100%; }
        input { width: 100%; padding: 8px; font-family: 'DungGeunMo'; font-size: 1rem; background: #000; color: #fff; border: 2px solid #555; outline: none; text-align: center; }
        input.caught { border-color: red; background: #400; }

        @keyframes shake { 0% { transform: translateY(-2px); } 100% { transform: translateY(2px); } }
    </style>
</head>
<body>

<div id="lobby">
    <h1 class="lobby-title">ì§„ì§œ ì»´í“¨í„°ì‹¤ íƒ€ì ëŒ€ê²°</h1>
    <div id="btn-group">
        <button class="monitor-btn" onclick="selectPos(1)">ëª¨ë‹ˆí„° 1 ì„ íƒ</button>
        <button class="monitor-btn" onclick="selectPos(2)">ëª¨ë‹ˆí„° 2 ì„ íƒ</button>
        <button class="monitor-btn" onclick="selectPos(3)">ëª¨ë‹ˆí„° 3 ì„ íƒ</button>
        <button class="monitor-btn" onclick="selectPos(4)">ëª¨ë‹ˆí„° 4 ì„ íƒ</button>
    </div>
    <button id="btn-start" class="start-trigger" onclick="triggerStart()" style="display:none;">ìˆ˜ì—… ì‹œì‘! (ëª¨ë‘ ë™ì‹œ ì‹œì‘)</button>
    <p id="wait-msg" style="color: #666; margin-top: 20px;">ìë¦¬ë¥¼ ê³ ë¥´ê³  ì¹œêµ¬ë“¤ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”.</p>
</div>

<div id="game-container">
    <div id="header">
        <div id="score-board">
            <div class="score red">RED: <span id="score-red">0</span></div>
            <div style="color: #fff;">VS</div>
            <div class="score blue">BLUE: <span id="score-blue">0</span></div>
        </div>
        <div id="timer-text" style="font-size:1.2rem;">ë‚¨ì€ ì‹œê°„: 300.0s</div>
        <div class="time-bar-bg"><div id="time-bar"></div></div>
    </div>

    <div id="game-grid">
        <div id="cont-1" class="monitor-container"><div class="teacher-box t-all">ğŸ‘¨â€ğŸ«</div><div id="mon-1" class="monitor-frame red-team"><div class="board" id="board-1"></div><div class="input-area"><input type="text" id="in-1" placeholder="RED"></div></div></div>
        <div id="cont-2" class="monitor-container"><div class="teacher-box t-all">ğŸ‘¨â€ğŸ«</div><div id="mon-2" class="monitor-frame blue-team"><div class="board" id="board-2"></div><div class="input-area"><input type="text" id="in-2" placeholder="BLUE"></div></div></div>
        <div id="cont-3" class="monitor-container"><div class="teacher-box t-all">ğŸ‘¨â€ğŸ«</div><div id="mon-3" class="monitor-frame red-team"><div class="board" id="board-3"></div><div class="input-area"><input type="text" id="in-3" placeholder="RED"></div></div></div>
        <div id="cont-4" class="monitor-container"><div id="t-4" class="teacher-box t-all">ğŸ‘¨â€ğŸ«</div><div id="mon-4" class="monitor-frame blue-team"><div class="board" id="board-4"></div><div class="input-area"><input type="text" id="in-4" placeholder="BLUE"></div></div></div>
    </div>
</div>

<script>
    const schoolWords = ["ë–¡ë³¶ì´", "ê¸‰ì‹", "ìš´ë™ì¥", "ë°›ì•„ì“°ê¸°", "ë°©í•™", "ìš°ìœ ê¸‰ì‹", "ì•Œë¦¼ì¥", "ì§ê¿", "ì¤€ë¹„ë¬¼", "ì‹¤ë‚´í™”", "ìƒ‰ì¢…ì´", "ë”±ì§€", "ìŠ¬ëŸ¬ì‹œ", "í”¼ì¹´ì¸„", "í•™ì›", "ìˆ™ì œ", "ì²´ìœ¡", "ì†Œí’", "ì‰¬ëŠ”ì‹œê°„", "ì§€ìš°ê°œ", "í•„í†µ", "ì‹¤ë¡œí°", "ë¦¬ì½”ë”", "ë°˜ì¥", "ì¼ê¸°", "ë…ì„œ", "í”¼êµ¬", "íƒœê¶Œë„", "ë¬¸ë°©êµ¬", "ë½‘ê¸°", "ë¶„ì‹ì§‘", "êµì‹¤", "ëª¨ë‘ í™œë™", "êµì¥ì„ ìƒë‹˜", "ìš´ë™íšŒ", "ë§¤ì ", "ì¹ íŒ", "ë¶„í•„", "ì‹¤ë‚´í™”ê°€ë°©", "ì •ë¬¸"];

    let myPos = 0;
    let gameActive = false;
    let isTeacherWatching = false;

    // ë°ì´í„° ì´ˆê¸°í™”
    localStorage.removeItem('game_command');
    localStorage.setItem('game_state', JSON.stringify({cards: {}, redScore: 0, blueScore: 0, shuffleSeed: 0}));

    function selectPos(num) {
        myPos = num;
        document.getElementById('wait-msg').innerText = `${num}ë²ˆ ìë¦¬ ì„ íƒ ì™„ë£Œ!`;
        document.getElementById('btn-start').style.display = 'block';
        
        // ë‚´ ëª¨ë‹ˆí„° ê°•ì¡° í‘œì‹œ
        for(let i=1; i<=4; i++) {
            document.getElementById(`mon-${i}`).classList.remove('my-border');
        }
        document.getElementById(`mon-${num}`).classList.add('my-border');
    }

    function triggerStart() {
        localStorage.setItem('game_command', 'START_' + Date.now());
    }

    window.addEventListener('storage', (e) => {
        if (e.key === 'game_command' && e.newValue.startsWith('START')) runGame();
        if (e.key === 'game_state') syncUI();
    });

    function runGame() {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        initBoards();
        gameActive = true;

        let timeLeft = 3000;
        const timer = setInterval(() => {
            timeLeft--;
            document.getElementById('time-bar').style.width = (timeLeft / 3000) * 100 + "%";
            document.getElementById('timer-text').innerText = `ë‚¨ì€ ì‹œê°„: ${(timeLeft / 10).toFixed(1)}s`;

            // 1. ì„ ìƒë‹˜ ê°ì‹œ ë™ê¸°í™”
            const cycle = timeLeft % 200;
            const boxes = document.querySelectorAll('.t-all');
            if (cycle <= 20) {
                isTeacherWatching = true;
                boxes.forEach(b => { b.classList.add('watching'); b.innerText = "ğŸ‘€"; });
            } else {
                isTeacherWatching = false;
                boxes.forEach(b => { b.classList.remove('watching'); b.innerText = "ğŸ‘¨â€ğŸ«"; });
            }

            // 2. ìœ„ì¹˜ ì…”í”Œ ë™ê¸°í™” (10ì´ˆë§ˆë‹¤)
            if (timeLeft % 100 === 0 && timeLeft > 0) {
                shuffleLayout();
            }

            if (timeLeft <= 0) {
                clearInterval(timer);
                finishGame();
            }
        }, 100);

        setupInputs();
    }

    function initBoards() {
        for(let i=1; i<=4; i++) {
            const board = document.getElementById(`board-${i}`);
            board.innerHTML = '';
            schoolWords.forEach(w => {
                const c = document.createElement('div');
                c.className = 'card';
                c.innerText = w;
                c.id = `mon-${i}-card-${w}`;
                board.appendChild(c);
            });
        }
    }

    function shuffleLayout() {
        if (!gameActive || isTeacherWatching) return;
        const grid = document.getElementById('game-grid');
        const containers = Array.from(document.querySelectorAll('.monitor-container'));
        containers.sort(() => Math.random() - 0.5);
        containers.forEach(c => grid.appendChild(c));
    }

    function setupInputs() {
        for(let i=1; i<=4; i++) {
            const input = document.getElementById(`in-${i}`);
            const team = (i === 1 || i === 3) ? 'red' : 'blue';
            
            // ë‹¤ë¥¸ ì‚¬ëŒì˜ ì…ë ¥ì°½ì€ ë¹„í™œì„±í™” (ë‚´ ìë¦¬ë§Œ ì…ë ¥ ê°€ëŠ¥)
            if (i !== myPos) {
                input.disabled = true;
                input.placeholder = "ìƒëŒ€ë°© í™”ë©´";
            }

            input.addEventListener('keydown', (e) => {
                if (isTeacherWatching) {
                    input.classList.add('caught');
                    setTimeout(() => input.classList.remove('caught'), 500);
                    
                    let state = JSON.parse(localStorage.getItem('game_state'));
                    let myTeamCards = schoolWords.filter(w => state.cards[w] === team);
                    if (myTeamCards.length > 0) {
                        delete state.cards[myTeamCards[Math.floor(Math.random()*myTeamCards.length)]];
                        updateState(state);
                    }
                    input.value = '';
                    e.preventDefault();
                    return;
                }

                if (e.key === 'Enter') {
                    const val = input.value.trim();
                    let state = JSON.parse(localStorage.getItem('game_state'));
                    if (schoolWords.includes(val) && !state.cards[val]) {
                        state.cards[val] = team;
                        updateState(state);
                    }
                    input.value = '';
                }
            });
        }
    }

    function updateState(state) {
        state.redScore = schoolWords.filter(w => state.cards[w] === 'red').length;
        state.blueScore = schoolWords.filter(w => state.cards[w] === 'blue').length;
        localStorage.setItem('game_state', JSON.stringify(state));
        syncUI();
    }

    function syncUI() {
        const state = JSON.parse(localStorage.getItem('game_state'));
        document.getElementById('score-red').innerText = state.redScore;
        document.getElementById('score-blue').innerText = state.blueScore;

        for(let i=1; i<=4; i++) {
            schoolWords.forEach(w => {
                const card = document.getElementById(`mon-${i}-card-${w}`);
                card.className = 'card' + (state.cards[w] ? ' ' + state.cards[w] : '');
            });
        }
    }

    function finishGame() {
        gameActive = false;
        const state = JSON.parse(localStorage.getItem('game_state'));
        alert(`ìˆ˜ì—… ì¢…ë£Œ!\nìµœì¢… ì ìˆ˜ - RED: ${state.redScore} : BLUE: ${state.blueScore}`);
        location.reload();
    }
</script>
</body>
</html>
