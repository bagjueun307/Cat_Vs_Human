<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì´ˆë“±í•™êµ ì»´í“¨í„°ì‹¤ ë©€í‹°í”Œë ˆì´ V27: ìµœì¢… ì—°ë™íŒ</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <style>
        body { background: #000; color: #00ff00; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        #lobby { position: fixed; inset: 0; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .monitor-btn { width: 150px; height: 80px; font-family: 'DungGeunMo'; font-size: 1.1rem; cursor: pointer; margin: 10px; background: #333; color: white; border: 4px outset #888; }
        .start-trigger { margin-top: 30px; padding: 15px 40px; font-size: 1.5rem; background: #f1c40f; color: #000; cursor: pointer; border: none; font-family: 'DungGeunMo'; }

        #game-container { display: none; flex-direction: column; align-items: center; width: 100vw; height: 100vh; padding: 20px; box-sizing: border-box; }
        #header { width: 100%; max-width: 1000px; display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        #score-board { display: flex; gap: 40px; font-size: 2rem; margin-bottom: 10px; }
        .score.red { color: #e74c3c; text-shadow: 0 0 10px #e74c3c; }
        .score.blue { color: #3498db; text-shadow: 0 0 10px #3498db; }
        .time-bar-bg { width: 100%; height: 20px; background: #111; border: 2px inset #555; position: relative; }
        #time-bar { width: 100%; height: 100%; background: #00ff00; transition: width 0.1s linear; }

        .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        .teacher-box { width: 120px; height: 90px; font-size: 4rem; display: flex; justify-content: center; align-items: center; background: #333; border: 5px solid #555; border-radius: 15px 15px 0 0; margin-bottom: -5px; }
        .teacher-box.watching { background: #ff0000; animation: shake 0.1s infinite; }

        .monitor-frame { width: 100%; max-width: 900px; border: 12px outset #aaa; background: #000; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; }
        .red-team { border-color: #e74c3c !important; box-shadow: 0 0 20px rgba(231, 76, 60, 0.4); }
        .blue-team { border-color: #3498db !important; box-shadow: 0 0 20px rgba(52, 152, 219, 0.4); }

        .board { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; flex: 1; }
        .card { height: 35px; background: #222; color: #444; font-size: 0.8rem; display: flex; justify-content: center; align-items: center; border-radius: 4px; border: 1px solid #333; transition: all 0.2s; }
        .card.red { background: #e74c3c; color: white; border: none; }
        .card.blue { background: #3498db; color: white; border: none; }

        .input-area { margin-top: 20px; width: 100%; }
        #player-input { width: 100%; padding: 15px; font-family: 'DungGeunMo'; font-size: 1.8rem; background: #000; color: #fff; border: 4px solid #555; outline: none; text-align: center; }
        #player-input.caught { border-color: red; background: #400; }
        @keyframes shake { 0% { transform: translateY(-2px); } 100% { transform: translateY(2px); } }
    </style>
</head>
<body>

<div id="lobby">
    <h1 class="lobby-title">ì§„ì§œ ì»´í“¨í„°ì‹¤ ì‹¤ì‹œê°„ ëŒ€ê²°</h1>
    <div>
        <button class="monitor-btn" onclick="assignPos(1)">ëª¨ë‹ˆí„° 1</button>
        <button class="monitor-btn" onclick="assignPos(2)">ëª¨ë‹ˆí„° 2</button>
        <button class="monitor-btn" onclick="assignPos(3)">ëª¨ë‹ˆí„° 3</button>
        <button class="monitor-btn" onclick="assignPos(4)">ëª¨ë‹ˆí„° 4</button>
    </div>
    <button id="btn-start" class="start-trigger" onclick="broadcastStart()" style="display:none;">ë‹¤ ê°™ì´ ì‹œì‘!</button>
    <p id="status-msg" style="color: #666; margin-top: 20px;">ìë¦¬ë¥¼ ê³ ë¥´ë©´ ì‹œì‘ ë²„íŠ¼ì´ ë‚˜ì˜µë‹ˆë‹¤.</p>
</div>

<div id="game-container">
    <div id="header">
        <div id="score-board">
            <div class="score red">RED: <span id="score-red">0</span></div>
            <div style="color: #fff;">VS</div>
            <div class="score blue">BLUE: <span id="score-blue">0</span></div>
        </div>
        <div id="timer-text" style="font-size:1.5rem;">ë‚¨ì€ ìˆ˜ì—… ì‹œê°„: 300.0s</div>
        <div class="time-bar-bg"><div id="time-bar"></div></div>
    </div>
    <div class="stage">
        <div id="teacher" class="teacher-box">ğŸ‘¨â€ğŸ«</div>
        <div id="my-monitor" class="monitor-frame">
            <div id="main-board" class="board"></div>
            <div class="input-area"><input type="text" id="player-input" placeholder="ì—¬ê¸°ì— ì…ë ¥!"></div>
        </div>
        <div id="info-text" style="margin-top:15px; color:#f1c40f; font-size: 1.2rem;"></div>
    </div>
</div>

<script>
    const schoolWords = ["ë–¡ë³¶ì´", "ê¸‰ì‹", "ìš´ë™ì¥", "ë°›ì•„ì“°ê¸°", "ë°©í•™", "ìš°ìœ ê¸‰ì‹", "ì•Œë¦¼ì¥", "ì§ê¿", "ì¤€ë¹„ë¬¼", "ì‹¤ë‚´í™”", "ìƒ‰ì¢…ì´", "ë”±ì§€", "ìŠ¬ëŸ¬ì‹œ", "í”¼ì¹´ì¸„", "í•™ì›", "ìˆ™ì œ", "ì²´ìœ¡", "ì†Œí’", "ì‰¬ëŠ”ì‹œê°„", "ì§€ìš°ê°œ", "í•„í†µ", "ì‹¤ë¡œí°", "ë¦¬ì½”ë”", "ë°˜ì¥", "ì¼ê¸°", "ë…ì„œ", "í”¼êµ¬", "íƒœê¶Œë„", "ë¬¸ë°©êµ¬", "ë½‘ê¸°", "ë¶„ì‹ì§‘", "êµì‹¤", "ëª¨ë‘ í™œë™", "êµì¥ì„ ìƒë‹˜", "ìš´ë™íšŒ", "ë§¤ì ", "ì¹ íŒ", "ë¶„í•„", "ì‹¤ë‚´í™”ê°€ë°©", "ì •ë¬¸"];
    
    let myPos = 0, gameActive = false, isTeacherWatching = false, myTeam = '';

    // ì´ˆê¸° ìƒíƒœ ê°•ì œ ì„¤ì •
    function clearGameState() {
        localStorage.setItem('game_state', JSON.stringify({cards: {}, redScore: 0, blueScore: 0, teams: [1, 2, 3, 4]}));
        localStorage.removeItem('game_command');
    }

    function assignPos(num) {
        myPos = num;
        document.getElementById('status-msg').innerText = `${num}ë²ˆ ëª¨ë‹ˆí„° ëŒ€ê¸°...`;
        document.getElementById('btn-start').style.display = 'inline-block';
    }

    function broadcastStart() {
        clearGameState(); // ì‹œì‘ ì‹œ ë°ì´í„° ì´ˆê¸°í™”
        setTimeout(() => {
            localStorage.setItem('game_command', 'START_' + Date.now());
            runGame();
        }, 100);
    }

    window.addEventListener('storage', (e) => {
        if (e.key === 'game_command' && e.newValue.startsWith('START')) {
            if(!gameActive) runGame();
        }
        if (e.key === 'game_state') {
            syncUI();
        }
    });

    function runGame() {
        if (gameActive) return;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        initBoard();
        gameActive = true;

        let timeLeft = 3000;
        const timer = setInterval(() => {
            timeLeft--;
            document.getElementById('time-bar').style.width = (timeLeft / 3000) * 100 + "%";
            document.getElementById('timer-text').innerText = `ë‚¨ì€ ìˆ˜ì—… ì‹œê°„: ${(timeLeft / 10).toFixed(1)}s`;

            const cycle = timeLeft % 200;
            if (cycle <= 20) {
                isTeacherWatching = true;
                document.getElementById('teacher').classList.add('watching');
                document.getElementById('teacher').innerText = "ğŸ‘€";
            } else {
                isTeacherWatching = false;
                document.getElementById('teacher').classList.remove('watching');
                document.getElementById('teacher').innerText = "ğŸ‘¨â€ğŸ«";
            }

            // 10ì´ˆë§ˆë‹¤ íŒ€ ì…”í”Œ (1ë²ˆ ëª¨ë‹ˆí„°ê°€ ì£¼ë„)
            if (timeLeft % 100 === 0 && timeLeft > 0 && myPos === 1) {
                let state = JSON.parse(localStorage.getItem('game_state'));
                state.teams = [1, 2, 3, 4].sort(() => Math.random() - 0.5);
                localStorage.setItem('game_state', JSON.stringify(state));
                syncUI();
            }

            if (timeLeft <= 0) { clearInterval(timer); endGame(); }
        }, 100);
        handleInput();
    }

    function initBoard() {
        const b = document.getElementById('main-board');
        b.innerHTML = '';
        schoolWords.forEach(w => {
            const c = document.createElement('div');
            c.className = 'card'; c.innerText = w; c.id = `card-${w}`;
            b.appendChild(c);
        });
        syncUI();
    }

    function syncUI() {
        const state = JSON.parse(localStorage.getItem('game_state'));
        if(!state) return;

        // íŒ€ ê²°ì • ë¡œì§
        const myIndex = state.teams.indexOf(myPos);
        myTeam = myIndex < 2 ? 'red' : 'blue';

        // ë‚´ í™”ë©´ ìƒ‰ìƒ ë°˜ì˜
        const frame = document.getElementById('my-monitor');
        frame.classList.remove('red-team', 'blue-team');
        frame.classList.add(myTeam === 'red' ? 'red-team' : 'blue-team');
        
        document.getElementById('info-text').innerText = `ë‚´ ìœ„ì¹˜: ${myPos}ë²ˆ | í˜„ì¬ íŒ€: ${myTeam.toUpperCase()}`;
        document.getElementById('score-red').innerText = state.redScore;
        document.getElementById('score-blue').innerText = state.blueScore;

        // ì¹´ë“œ ìƒ‰ê¹” ì‹¤ì‹œê°„ ë°˜ì˜ (ì¤‘ìš”!)
        schoolWords.forEach(w => {
            const card = document.getElementById(`card-${w}`);
            if(card) {
                const owner = state.cards[w];
                card.className = 'card' + (owner ? ' ' + owner : '');
            }
        });
    }

    function handleInput() {
        const input = document.getElementById('player-input');
        input.focus();
        input.addEventListener('keydown', (e) => {
            if (isTeacherWatching) {
                input.classList.add('caught'); setTimeout(() => input.classList.remove('caught'), 500);
                let state = JSON.parse(localStorage.getItem('game_state'));
                let myCards = schoolWords.filter(w => state.cards[w] === myTeam);
                if (myCards.length > 0) {
                    delete state.cards[myCards[Math.floor(Math.random() * myCards.length)]];
                    updateState(state);
                }
                input.value = ''; e.preventDefault(); return;
            }
            if (e.key === 'Enter') {
                const val = input.value.trim();
                let state = JSON.parse(localStorage.getItem('game_state'));
                if (schoolWords.includes(val) && !state.cards[val]) {
                    state.cards[val] = myTeam;
                    updateState(state);
                }
                input.value = '';
            }
        });
    }

    function updateState(state) {
        state.redScore = schoolWords.filter(w => state.cards[w] === 'red').length;
        state.blueScore = schoolWords.filter(w => state.cards[w] === 'blue').length;
        localStorage.setItem('game_state', JSON.stringify(state));
        syncUI(); // ë‚´ í™”ë©´ ì¦‰ì‹œ ê°±ì‹ 
    }

    function endGame() {
        gameActive = false;
        const state = JSON.parse(localStorage.getItem('game_state'));
        alert(`ìˆ˜ì—… ì¢…ë£Œ!\nREDíŒ€: ${state.redScore} : BLUEíŒ€: ${state.blueScore}`);
        localStorage.clear();
        location.reload();
    }
</script>
</body>
</html>
